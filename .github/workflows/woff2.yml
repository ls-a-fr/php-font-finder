name: Build Woff2 Decompress utility
# This workflow allows to build woff2_decompress and embed it in source code.
# Doing so ensures this library is easy to use for production, but also to contribute on.
# 
# This workflow checks for any change in woff2_decompress binaries to prevent push of same binaries
# over and over. When a new version of woff2 is released, you mean to manually launch this action.
# This behavior is intended, to prevent security risks such as supply chain attack on woff2 repository.
#
# Currently, this workflow contains everything there is to include in deps folder, so it's designed as a
# straightforward script. If other binaries are needed in this library, a more composable approach will
# be used, using actions next to this workflow.
#
# Workflow process:
#                       /-- [ build-windows ] --\
#                      /---- [ build-linux ] ----\
# [ check-versions ] ------ [ build-darwin ] ------- [ collect-and-push ]
# -> May stop workflow \--- [ build-solaris ] ---/    -> Push to deps directory
#                       \---- [ build-bsd ] ----/
#
# You may reuse and modify this workflow for your projects as you see fit. If this workflow helps you,
# consider staring this project, it helps us moving forward!
on:
  workflow_dispatch:

env:
  CMAKEVER: 3.15
  CONFIG: Release
  VERSIONFILE: deps/VERSION

jobs:
  # check-versions:
  # - pull woff2 repository
  # - checks last commit for woff2 and brotli
  # - compares them to deps/VERSION contents in this project
  # - if same:
  #   - stops there.
  # - if different:
  #   - changes happened, needs to rebuild
  #   - modifies deps/VERSION for future workflow usage
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - uses: actions/checkout@v6

      # Pull woff2 repository into a "tmp" folder
      - name: Pull woff2 repository
        uses: actions/checkout@v6
        with:
          repository: google/woff2
          submodules: true
          fetch-depth: 0
          path: tmp

      - name: Check versions
        id: check
        run: |
          # Paths
          mkdir -p deps

          # Current commits
          WOFF2_COMMIT=$(git -C tmp rev-parse HEAD)
          BROTLI_COMMIT=$(git -C tmp/brotli rev-parse HEAD || git -C tmp/brotli rev-parse HEAD)

          # Read previous commits if file exists
          PREV_WOFF2=""
          PREV_BROTLI=""
          if [ -f "${{ env.VERSIONFILE }}" ]; then
            PREV_WOFF2=$(grep '^woff2:' "${{ env.VERSIONFILE }}" | cut -d' ' -f2)
            PREV_BROTLI=$(grep '^brotli:' "${{ env.VERSIONFILE }}" | cut -d' ' -f2)
          fi

          echo "Current WOFF2 commit: $WOFF2_COMMIT"
          echo "Current BROTLI commit: $BROTLI_COMMIT"
          echo "Previous WOFF2 commit: $PREV_WOFF2"
          echo "Previous BROTLI commit: $PREV_BROTLI"

          # Compare
          if [ "$WOFF2_COMMIT" = "$PREV_WOFF2" ] && [ "$BROTLI_COMMIT" = "$PREV_BROTLI" ]; then
            echo "No source changes detected. Skipping builds."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Sources changed. Build required."
            echo "changed=true" >> $GITHUB_OUTPUT

            # Update VERSIONFILE for next runs
            echo "woff2: $WOFF2_COMMIT" > "${{ env.VERSIONFILE }}"
            echo "brotli: $BROTLI_COMMIT" >> "${{ env.VERSIONFILE }}"
          fi

      - name: Copy VERSIONFILE to root
        if: steps.check.outputs.changed == 'true'
        run: cp ${{ env.VERSIONFILE }} VERSION

      # Upload artifacts. These artifacts will be used later, in collect-and-push action.
      - name: Upload VERSIONFILE artifact
        uses: actions/upload-artifact@v4
        if: steps.check.outputs.changed == 'true'
        with:
          name: VERSION
          path: VERSION

      # Upload sources for all build jobs
      - name: Upload woff2 sources
        uses: actions/upload-artifact@v4
        if: steps.check.outputs.changed == 'true'
        with:
          name: _external-woff2-sources
          path: tmp

  # Build woff2_decompress on Windows (amd64 and i386) and push them as artifacts
  build-windows:
    runs-on: windows-latest
    needs: check-versions
    if: needs.check-versions.outputs.changed == 'true'

    strategy:
      matrix:
        include:
          - arch: amd64
            msvc_arch: x64
            devcmd_arch: x64

          - arch: i386
            msvc_arch: Win32
            devcmd_arch: x86

    defaults:
      run:
        shell: bash
    steps:
      # Checkouts this repository
      - uses: actions/checkout@v6

      # Download artifact created in prepare-sources
      - name: Download woff2 sources
        uses: actions/download-artifact@v7
        with:
          name: _external-woff2-sources
          path: tmp

      # Configures brotli build with CMake, with msvc_arch defined by above matrix
      - name: Configures build for brotli
        working-directory: tmp/brotli
        run: |
          cmake -S . -B build-${{ matrix.arch }} -A ${{ matrix.msvc_arch }} \
            -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }} \

      # Builds brotli based on previous step, and CONFIG defined in environment section
      - name: Build brotli
        working-directory: tmp/brotli
        run: cmake --build build-${{ matrix.arch }} --config ${{ env.CONFIG }}

      # Configures woff2 build with CMake, with msvc_arch defined by above matrix
      # This configuration needs some flags: include brotli, define Windows runtime
      - name: Configures build for woff2
        working-directory: tmp
        run: |
          cmake -S . -B build-${{ matrix.arch }} -A ${{ matrix.msvc_arch }} \
            -DCMAKE_POLICY_VERSION_MINIMUM=$CMAKEVER \
            -DCMAKE_WINDOWS_EXPORT_ALL_SYMBOLS=TRUE \
            -DBUILD_SHARED_LIBS=FALSE \
            -DBROTLIDEC_INCLUDE_DIRS="brotli/c/include" \
            -DBROTLIDEC_LIBRARIES="brotli/build-${{ matrix.arch }}/${{ env.CONFIG }}/brotlidec.lib" \
            -DBROTLIENC_INCLUDE_DIRS="brotli/c/include" \
            -DBROTLIENC_LIBRARIES="brotli/build-${{ matrix.arch }}/${{ env.CONFIG }}/brotlienc.lib" \

      # Builds woff2 based on previous step, and CONFIG defined in environment section
      - name: Build woff2
        working-directory: tmp
        run: cmake --build build-${{ matrix.arch }} --config ${{ env.CONFIG }}

      # Artifacts are stored as windows-${{ matrix.arch }}/woff2_decompress.exe
      # We need to create a folder, and then push this folder as an artifact
      - name: Prepare artifact structure
        run: |
          mkdir -p artifact/windows-${{ matrix.arch }}
          cp tmp/build-${{ matrix.arch }}/${{ env.CONFIG }}/woff2_decompress.exe \
            artifact/windows-${{ matrix.arch }}/

      # Upload artifacts. These artifacts will be used later, in collect-and-push action.
      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: artifact/windows-${{ matrix.arch }}

  # Build woff2_decompress on macOS (Intel and Apple Silicon) and push them as artifacts
  build-darwin:
    runs-on: macos-latest
    needs: check-versions
    if: needs.check-versions.outputs.changed == 'true'

    strategy:
      matrix:
        include:
          - arch: amd64
            osx_arch: x86_64

          - arch: arm64
            osx_arch: arm64

    defaults:
      run:
        shell: bash

    steps:
      # Checkouts this repository
      - uses: actions/checkout@v6

      # Download artifact created in check-versions
      - name: Download woff2 sources
        uses: actions/download-artifact@v7
        with:
          name: _external-woff2-sources
          path: tmp

      # Configures brotli build with CMake, with osx_arch defined by above matrix
      - name: Configures build for brotli
        working-directory: tmp/brotli
        run: |
          cmake -S . -B build-${{ matrix.arch }} \
            -DCMAKE_BUILD_TYPE=${{ env.CONFIG }} \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.osx_arch }} \
            -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }} \
            -DBUILD_SHARED_LIBS=FALSE

      # Builds brotli based on previous step, and CONFIG defined in environment section
      - name: Build brotli
        working-directory: tmp/brotli
        run: |
          cmake --build build-${{ matrix.arch }}

      # Configures woff2 build with CMake, with osx_arch defined by above matrix
      # This configuration needs some flags: include brotli, disable shared libs
      - name: Configures build for woff2
        working-directory: tmp
        run: |
          cmake -S . -B build-${{ matrix.arch }} \
            -DCMAKE_BUILD_TYPE=${{ env.CONFIG }} \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.osx_arch }} \
            -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }} \
            -DBUILD_SHARED_LIBS=FALSE \
            -DBROTLIDEC_INCLUDE_DIRS="brotli/c/include" \
            -DBROTLIENC_INCLUDE_DIRS="brotli/c/include" \
            -DBROTLIDEC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlidec-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a" \
            -DBROTLIENC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlienc-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a"

      # Builds woff2 based on previous step
      - name: Build woff2
        working-directory: tmp
        run: cmake --build build-${{ matrix.arch }}

      # Artifacts are stored as darwin-${{ matrix.arch }}/woff2_decompress
      # We need to create a folder, and then push this folder as an artifact
      - name: Prepare artifact structure
        run: |
          mkdir -p artifact/darwin-${{ matrix.arch }}
          cp tmp/build-${{ matrix.arch }}/woff2_decompress \
            artifact/darwin-${{ matrix.arch }}/

      # Upload artifacts. These artifacts will be used later, in collect-and-push action.
      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: darwin-${{ matrix.arch }}
          path: artifact/darwin-${{ matrix.arch }}

  # Build woff2_decompress on Linux (amd64, arm64 and armv7) and push them as artifacts
  # It's nice to see in the workflow diagram a "build-linux" single card, but let's be honest,
  # a lot of steps are if/elif/else between amd64, arm64 and armv7. You may find it easier to
  # divide this job in three.
  build-linux:
    runs-on: ubuntu-latest
    needs: check-versions
    if: needs.check-versions.outputs.changed == 'true'

    strategy:
      matrix:
        include:
          - arch: amd64
          - arch: arm64
          - arch: armv7

    defaults:
      run:
        shell: bash

    steps:
      # Checkouts this repository
      - uses: actions/checkout@v6

      # Download artifact created in check-versions
      - name: Download woff2 sources
        uses: actions/download-artifact@v7
        with:
          name: _external-woff2-sources
          path: tmp

      # Install build tools
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      # ARMv7 needs specific gcc compiler tools
      - name: Install ARMv7 toolchain
        if: matrix.arch == 'armv7'
        run: sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
      
      # ARM64 needs specific gcc compiler tools
      - name: Install ARM64 toolchain
        if: matrix.arch == 'arm64'
        run: sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      # Configures brotli build with CMake
      # With ARMv7 and ARM64, you need to specify flags for CMAKE_C_COMPILER and 
      # CMAKE_CXX_COMPILER. Be careful, these flags are different.
      - name: Configures build for brotli
        working-directory: tmp/brotli
        run: |
          rm -rf build-${{ matrix.arch }}
          if [ "${{ matrix.arch }}" = "armv7" ]; then
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_C_COMPILER=arm-linux-gnueabihf-gcc \
              -DCMAKE_CXX_COMPILER=arm-linux-gnueabihf-g++ \
              -DCMAKE_BUILD_TYPE=${{ env.CONFIG }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }}
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
              -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
              -DCMAKE_BUILD_TYPE=${{ env.CONFIG }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }}
          else
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_BUILD_TYPE=${{ env.CONFIG }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }}
          fi

      # Builds brotli based on previous step
      - name: Build brotli
        working-directory: tmp/brotli
        run: cmake --build build-${{ matrix.arch }}

      # Configures woff2 build with CMake
      # This configuration needs some flags: include brotli, disable shared libs
      # With ARMv7 and ARM64, you need to include *-static.a libraries, and specify flags for
      # CMAKE_C_COMPILER and CMAKE_CXX_COMPILER. Be careful, these flags are different.
      - name: Configures build for woff2
        working-directory: tmp
        run: |
          if [ "${{ matrix.arch }}" = "armv7" ]; then
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_BUILD_TYPE=${{ env.CONFIG }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }} \
              -DBUILD_SHARED_LIBS=FALSE \
              -DBROTLIDEC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIENC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIDEC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlidec-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a" \
              -DBROTLIENC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlienc-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a" \
              -DCMAKE_C_COMPILER=arm-linux-gnueabihf-gcc \
              -DCMAKE_CXX_COMPILER=arm-linux-gnueabihf-g++
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_BUILD_TYPE=${{ env.CONFIG }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }} \
              -DBUILD_SHARED_LIBS=FALSE \
              -DBROTLIDEC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIENC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIDEC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlidec-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a" \
              -DBROTLIENC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlienc-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a" \
              -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
              -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
          else
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_BUILD_TYPE=${{ env.CONFIG }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }} \
              -DBUILD_SHARED_LIBS=FALSE \
              -DBROTLIDEC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIENC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIDEC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlidec-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a" \
              -DBROTLIENC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlienc-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a"
          fi

      # Builds woff2 based on previous step
      - name: Build woff2
        working-directory: tmp
        run: cmake --build build-${{ matrix.arch }}

      # Artifacts are stored as linux-${{ matrix.arch }}/woff2_decompress
      # We need to create a folder, and then push this folder as an artifact
      - name: Prepare artifact structure
        run: |
          mkdir -p artifact/linux-${{ matrix.arch }}
          cp tmp/build-${{ matrix.arch }}/woff2_decompress \
            artifact/linux-${{ matrix.arch }}/

      # Upload artifacts. These artifacts will be used later, in collect-and-push action.
      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: artifact/linux-${{ matrix.arch }}

  # Build woff2_decompress on BSD (amd64 and arm64) and push them as artifacts
  build-bsd:
    runs-on: ubuntu-latest
    needs: check-versions
    if: needs.check-versions.outputs.changed == 'true'

    strategy:
      matrix:
        include:
          - os: freebsd
            version: '15.0'
            arch: amd64
            bsd_arch: x86-64

          - os: freebsd
            version: '15.0'
            arch: arm64
            bsd_arch: arm64

          - os: openbsd
            version: '7.8'
            arch: amd64
            bsd_arch: x86-64

          - os: openbsd
            version: '7.8'
            arch: arm64
            bsd_arch: arm64

    defaults:
      run:
        shell: bash

    steps:
      # Checkouts this repository
      - uses: actions/checkout@v6

      # Download artifact created in prepare-sources
      - name: Download woff2 sources
        uses: actions/download-artifact@v7
        with:
          name: _external-woff2-sources
          path: tmp

      # Run everything inside BSD VM
      - name: Build on ${{ matrix.os }} ${{ matrix.arch }}
        uses: cross-platform-actions/action@v0.32.0
        with:
          operating_system: ${{ matrix.os }}
          architecture: ${{ matrix.bsd_arch }}
          version: ${{ matrix.version }}
          shell: bash
          run: |

            set -e

            # Install required packages (BSD specific)
            if [ "${{ matrix.os }}" = "freebsd" ]; then
              sudo pkg update
              sudo pkg install -y cmake gmake git
            elif [ "${{ matrix.os }}" = "openbsd" ]; then
              sudo pkg_add cmake gmake git bash
            fi

            cd tmp

            # Configures brotli build with CMake
            cd brotli
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }}

            # Builds brotli based on previous step
            cmake --build build-${{ matrix.arch }}

            cd ..

            # Configures woff2 build with CMake
            # This configuration needs some flags: include brotli, disable shared libs
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=$CMAKEVER \
              -DBUILD_SHARED_LIBS=FALSE \
              -DBROTLIDEC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIENC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIDEC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlidec-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a" \
              -DBROTLIENC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlienc-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a"

            # Builds woff2 based on previous step
            cmake --build build-${{ matrix.arch }}

      # Artifacts are stored as bsd-${{ matrix.os }}-${{ matrix.arch }}/woff2_decompress
      # We need to create a folder, and then push this folder as an artifact
      - name: Prepare artifact structure
        run: |
          mkdir -p artifact/bsd-${{ matrix.os }}-${{ matrix.arch }}
          cp tmp/build-${{ matrix.arch }}/woff2_decompress \
            artifact/bsd-${{ matrix.os }}-${{ matrix.arch }}/

      # Upload artifacts. These artifacts will be used later, in collect-and-push action.
      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: bsd-${{ matrix.os }}-${{ matrix.arch }}
          path: artifact/bsd-${{ matrix.os }}-${{ matrix.arch }}

  # Build woff2_decompress on Solaris (x86_64 and aarch64) and push them as artifacts
  build-solaris:
    runs-on: ubuntu-latest
    needs: check-versions
    if: needs.check-versions.outputs.changed == 'true'

    strategy:
      matrix:
        include:
          - arch: amd64
            solaris_release: "11.4-gcc"
            bsd_arch: x86_64

    steps:
      # Check out this repository
      - uses: actions/checkout@v6

      # Download artifact created in prepare-sources
      - name: Download woff2 sources
        uses: actions/download-artifact@v7
        with:
          name: _external-woff2-sources
          path: tmp

      # Run everything inside Solaris VM
      - name: Build on Solaris ${{ matrix.arch }}
        uses: vmactions/solaris-vm@v1
        with:
          release: ${{ matrix.solaris_release }}
          arch: ${{ matrix.bsd_arch }}
          usesh: true
          run: |

            set -e

            # Install required packages
            sudo pkg install developer/gcc \
              developer/gcc-14 \
              developer/gcc/gcc-c++-14 \
              developer/build/gnu-make \
              developer/versioning/git

            # Update PATH for cc1plus
            export PATH=/usr/gcc/14/bin:$PATH
            export LD_LIBRARY_PATH=/usr/gcc/14/lib:/usr/gcc/14/lib/amd64:${LD_LIBRARY_PATH:-}

            cd tmp

            # Configures brotli build with CMake
            cd brotli
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }}
            
            cmake --build build-${{ matrix.arch }}

            cd ..

            # Configures woff2 build with CMake
            cmake -S . -B build-${{ matrix.arch }} \
              -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }} \
              -DBUILD_SHARED_LIBS=FALSE \
              -DBROTLIDEC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIDEC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlidec-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a" \
              -DBROTLIENC_INCLUDE_DIRS="brotli/c/include" \
              -DBROTLIENC_LIBRARIES="brotli/build-${{ matrix.arch }}/libbrotlienc-static.a;brotli/build-${{ matrix.arch }}/libbrotlicommon-static.a"

            cmake --build build-${{ matrix.arch }}

            # Prepare artifact structure
            # Folder needs to be located at GITHUB_WORKSPACE root, as Copyback only takes elements in
            # workspace root
            mkdir -p $GITHUB_WORKSPACE/artifact/solaris-${{ matrix.arch }}
            cp build-${{ matrix.arch }}/woff2_decompress $GITHUB_WORKSPACE/artifact/solaris-${{ matrix.arch }}/woff2_decompress

      # Upload artifacts. These artifacts will be used later, in collect-and-push action.
      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: solaris-${{ matrix.arch }}
          path: artifact/solaris-${{ matrix.arch }}

  # test-build-windows:
  #   runs-on: windows-latest
  #   if: needs.check-versions.outputs.changed == 'true'
  #   needs:
  #     - build-windows

  #   strategy:
  #     matrix:
  #       include:
  #         - arch: amd64
  #           msvc_arch: x64
  #           devcmd_arch: x64

  #         - arch: i386
  #           msvc_arch: Win32
  #           devcmd_arch: x86

    # defaults:
    #   run:
    #     shell: bash
    # steps:
    #   # Checkouts this repository
    #   - uses: actions/checkout@v6

    #   # Artifacts are stored in "deps" folder
    #   - name: Download artifacts in deps folder
    #     uses: actions/download-artifact@v7
    #     with:
    #       # Include all artifacts with a pattern: woff2 and brotli sources are uploaded as
    #       # an artifact, and you do not want to push this code in deps folder
    #       pattern: |
    #         windows-*
    #         VERSION
    #       path: deps
    #       merge-multiple: true


  # Gather artifacts, compare them to current version. If any change is detected, creates a new version
  # of this library.
  collect-and-push:
    runs-on: ubuntu-latest
    if: needs.check-versions.outputs.changed == 'true'
    needs:
      - build-windows
      - build-darwin
      - build-linux
      - build-bsd
      - build-solaris

    steps:
      - uses: actions/checkout@v6

      # Artifacts are stored in "deps" folder
      # We need several artifact download steps, one for each build. Multiple patterns does not
      # seem to be allowed. Be careful, woff2 and brotli sources are uploaded as an artifact, 
      # and you do not want to push this code in deps folder
      - name: Download Linux artifacts in deps folder
        uses: actions/download-artifact@v7
        with:
          pattern: linux-*
          path: deps
      - name: Download Windows artifacts in deps folder
        uses: actions/download-artifact@v7
        with:
          pattern: windows-*
          path: deps
      - name: Download Darwin artifacts in deps folder
        uses: actions/download-artifact@v7
        with:
          pattern: darwin-*
          path: deps
      - name: Download BSD artifacts in deps folder
        uses: actions/download-artifact@v7
        with:
          pattern: bsd-*
          path: deps
      - name: Download Solaris artifacts in deps folder
        uses: actions/download-artifact@v7
        with:
          pattern: solaris-*
          path: deps
      - name: Download VERSION artifact in deps folder
        uses: actions/download-artifact@v7
        with:
          name: VERSION
          path: deps

      - name: Bump version in composer.json
        id: bump_version
        run: |
          # String manipulation to bump version in composer.json file
          CURRENT=$(jq -r '.version' composer.json)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          NEW_MINOR=$((MINOR+1))
          NEW_VERSION="$MAJOR.$NEW_MINOR.0"
          jq --arg ver "$NEW_VERSION" '.version=$ver' composer.json > composer.json.tmp
          mv composer.json.tmp composer.json
          echo "Bumped version to $NEW_VERSION"

          # GitHub variables, used in next step
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      # Commit and push only if necessary. "if" directive ensures this step only triggers
      # when at least one binary actually changed
      - name: Commit & push executables
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add composer.json deps/* ${{ env.VERSIONFILE }}
          git commit -m "Bump version to ${{ steps.bump_version.outputs.new_version }} and add built executables" || echo "No changes"
          git tag "v${{ steps.bump_version.outputs.new_version }}" -a -m "Release v${{ steps.bump_version.outputs.new_version }}"
          git push
          git push origin "v${{ steps.bump_version.outputs.new_version }}"