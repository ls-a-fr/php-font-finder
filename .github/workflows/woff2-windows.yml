name: Build Woff2 Decompress utility
on:
  workflow_dispatch:

env:
  CMAKEVER: 3.15
  CONFIG: Release

jobs:
  build-windows:
    runs-on: windows-latest

    strategy:
      matrix:
        include:
          - arch: amd64
            msvc_arch: x64
            devcmd_arch: x64

          - arch: i386
            msvc_arch: Win32
            devcmd_arch: x86

    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v6

      - name: Pull woff2 repository
        uses: actions/checkout@v6
        with:
          repository: google/woff2
          submodules: true
          path: tmp

      - name: Configures build for brotli
        working-directory: tmp/brotli
        run: |
          cmake -S . -B build-${{ matrix.arch }} -A ${{ matrix.msvc_arch }} \
            -DCMAKE_POLICY_VERSION_MINIMUM=${{ env.CMAKEVER }}

      - name: Build brotli
        working-directory: tmp/brotli
        run: cmake --build build-${{ matrix.arch }} --config $CONFIG

      - name: Configures build for woff2
        working-directory: tmp
        run: |
          cmake -S . -B build-${{ matrix.arch }} -A ${{ matrix.msvc_arch }} \
            -DCMAKE_POLICY_VERSION_MINIMUM=$CMAKEVER \
            -DCMAKE_WINDOWS_EXPORT_ALL_SYMBOLS=TRUE \
            -DBUILD_SHARED_LIBS=FALSE \
            -DBROTLIDEC_INCLUDE_DIRS="brotli/c/include" \
            -DBROTLIDEC_LIBRARIES="brotli/build-${{ matrix.arch }}/$CONFIG/brotlidec.lib" \
            -DBROTLIENC_INCLUDE_DIRS="brotli/c/include" \
            -DBROTLIENC_LIBRARIES="brotli/build-${{ matrix.arch }}/$CONFIG/brotlienc.lib"

      - name: Build woff2
        working-directory: tmp
        run: cmake --build build-${{ matrix.arch }} --config $CONFIG

      - name: Copy built executable
        working-directory: tmp
        run: |
          mkdir -p deps
          cp build-${{ matrix.arch }}/$CONFIG/woff2_decompress.exe ../deps/woff_decompress-windows-${{ matrix.arch }}.exe
      
      - name: Upload exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: deps/woff_decompress-windows-${{ matrix.arch }}.exe

  collect-and-push:
    runs-on: ubuntu-latest
    needs:
      - build-windows
    steps:
      - uses: actions/checkout@v6

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: deps

      - name: Bump version in composer.json
        run: |
          if [ -z "$(find deps -type f ! -name '.*')" ]; then
            echo "No executables downloaded. Skipping version bump."
            echo "bumped=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          CURRENT=$(jq -r '.version' composer.json)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          NEW_MINOR=$((MINOR+1))
          NEW_VERSION="$MAJOR.$NEW_MINOR.0"
          jq --arg ver "$NEW_VERSION" '.version=$ver' composer.json > composer.json.tmp
          mv composer.json.tmp composer.json
          echo "Bumped version to $NEW_VERSION"

          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit & push executables
        if: steps.bump_version.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add composer.json deps/*
          git commit -m "Bump version to ${{ steps.bump_version.outputs.new_version }} and add built executables" || echo "No changes"
          git tag "v${{ steps.bump_version.outputs.new_version }}" -a -m "Release v${{ steps.bump_version.outputs.new_version }}"
          git push
          git push origin "v${{ steps.bump_version.outputs.new_version }}"